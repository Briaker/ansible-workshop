<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<!-- saved from url=(0047)https://docs.ansibleworkshop.com/exercise5.html -->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<meta name="generator" content="AsciiDoc 8.6.8">
<title>Automation for Everyone</title>
<style type="text/css">
/* Shared CSS for AsciiDoc xhtml11 and html5 backends */

/* Default font. */
body {
  font-family: Georgia,serif;
}

/* Title font. */
h1, h2, h3, h4, h5, h6,
div.title, caption.title,
thead, p.table.header,
#toctitle,
#author, #revnumber, #revdate, #revremark,
#footer {
  font-family: Arial,Helvetica,sans-serif;
}

body {
  margin: 1em 5% 1em 5%;
}

a {
  color: blue;
  text-decoration: underline;
}
a:visited {
  color: fuchsia;
}

em {
  font-style: italic;
  color: navy;
}

strong {
  font-weight: bold;
  color: #083194;
}

h1, h2, h3, h4, h5, h6 {
  color: #527bbd;
  margin-top: 1.2em;
  margin-bottom: 0.5em;
  line-height: 1.3;
}

h1, h2, h3 {
  border-bottom: 2px solid silver;
}
h2 {
  padding-top: 0.5em;
}
h3 {
  float: left;
}
h3 + * {
  clear: left;
}
h5 {
  font-size: 1.0em;
}

div.sectionbody {
  margin-left: 0;
}

hr {
  border: 1px solid silver;
}

p {
  margin-top: 0.5em;
  margin-bottom: 0.5em;
}

ul, ol, li > p {
  margin-top: 0;
}
ul > li     { color: #aaa; }
ul > li > * { color: black; }

.monospaced, code, pre {
  font-family: "Courier New", Courier, monospace;
  font-size: inherit;
  color: navy;
  padding: 0;
  margin: 0;
}


#author {
  color: #527bbd;
  font-weight: bold;
  font-size: 1.1em;
}
#email {
}
#revnumber, #revdate, #revremark {
}

#footer {
  font-size: small;
  border-top: 2px solid silver;
  padding-top: 0.5em;
  margin-top: 4.0em;
}
#footer-text {
  float: left;
  padding-bottom: 0.5em;
}
#footer-badges {
  float: right;
  padding-bottom: 0.5em;
}

#preamble {
  margin-top: 1.5em;
  margin-bottom: 1.5em;
}
div.imageblock, div.exampleblock, div.verseblock,
div.quoteblock, div.literalblock, div.listingblock, div.sidebarblock,
div.admonitionblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.admonitionblock {
  margin-top: 2.0em;
  margin-bottom: 2.0em;
  margin-right: 10%;
  color: #606060;
}

div.content { /* Block element content. */
  padding: 0;
}

/* Block element titles. */
div.title, caption.title {
  color: #527bbd;
  font-weight: bold;
  text-align: left;
  margin-top: 1.0em;
  margin-bottom: 0.5em;
}
div.title + * {
  margin-top: 0;
}

td div.title:first-child {
  margin-top: 0.0em;
}
div.content div.title:first-child {
  margin-top: 0.0em;
}
div.content + div.title {
  margin-top: 0.0em;
}

div.sidebarblock > div.content {
  background: #ffffee;
  border: 1px solid #dddddd;
  border-left: 4px solid #f0f0f0;
  padding: 0.5em;
}

div.listingblock > div.content {
  border: 1px solid #dddddd;
  border-left: 5px solid #f0f0f0;
  background: #f8f8f8;
  padding: 0.5em;
}

div.quoteblock, div.verseblock {
  padding-left: 1.0em;
  margin-left: 1.0em;
  margin-right: 10%;
  border-left: 5px solid #f0f0f0;
  color: #888;
}

div.quoteblock > div.attribution {
  padding-top: 0.5em;
  text-align: right;
}

div.verseblock > pre.content {
  font-family: inherit;
  font-size: inherit;
}
div.verseblock > div.attribution {
  padding-top: 0.75em;
  text-align: left;
}
/* DEPRECATED: Pre version 8.2.7 verse style literal block. */
div.verseblock + div.attribution {
  text-align: left;
}

div.admonitionblock .icon {
  vertical-align: top;
  font-size: 1.1em;
  font-weight: bold;
  text-decoration: underline;
  color: #527bbd;
  padding-right: 0.5em;
}
div.admonitionblock td.content {
  padding-left: 0.5em;
  border-left: 3px solid #dddddd;
}

div.exampleblock > div.content {
  border-left: 3px solid #dddddd;
  padding-left: 0.5em;
}

div.imageblock div.content { padding-left: 0; }
span.image img { border-style: none; }
a.image:visited { color: white; }

dl {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
dt {
  margin-top: 0.5em;
  margin-bottom: 0;
  font-style: normal;
  color: navy;
}
dd > *:first-child {
  margin-top: 0.1em;
}

ul, ol {
    list-style-position: outside;
}
ol.arabic {
  list-style-type: decimal;
}
ol.loweralpha {
  list-style-type: lower-alpha;
}
ol.upperalpha {
  list-style-type: upper-alpha;
}
ol.lowerroman {
  list-style-type: lower-roman;
}
ol.upperroman {
  list-style-type: upper-roman;
}

div.compact ul, div.compact ol,
div.compact p, div.compact p,
div.compact div, div.compact div {
  margin-top: 0.1em;
  margin-bottom: 0.1em;
}

tfoot {
  font-weight: bold;
}
td > div.verse {
  white-space: pre;
}

div.hdlist {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
div.hdlist tr {
  padding-bottom: 15px;
}
dt.hdlist1.strong, td.hdlist1.strong {
  font-weight: bold;
}
td.hdlist1 {
  vertical-align: top;
  font-style: normal;
  padding-right: 0.8em;
  color: navy;
}
td.hdlist2 {
  vertical-align: top;
}
div.hdlist.compact tr {
  margin: 0;
  padding-bottom: 0;
}

.comment {
  background: yellow;
}

.footnote, .footnoteref {
  font-size: 0.8em;
}

span.footnote, span.footnoteref {
  vertical-align: super;
}

#footnotes {
  margin: 20px 0 20px 0;
  padding: 7px 0 0 0;
}

#footnotes div.footnote {
  margin: 0 0 5px 0;
}

#footnotes hr {
  border: none;
  border-top: 1px solid silver;
  height: 1px;
  text-align: left;
  margin-left: 0;
  width: 20%;
  min-width: 100px;
}

div.colist td {
  padding-right: 0.5em;
  padding-bottom: 0.3em;
  vertical-align: top;
}
div.colist td img {
  margin-top: 0.3em;
}

@media print {
  #footer-badges { display: none; }
}

#toc {
  margin-bottom: 2.5em;
}

#toctitle {
  color: #527bbd;
  font-size: 1.1em;
  font-weight: bold;
  margin-top: 1.0em;
  margin-bottom: 0.1em;
}

div.toclevel0, div.toclevel1, div.toclevel2, div.toclevel3, div.toclevel4 {
  margin-top: 0;
  margin-bottom: 0;
}
div.toclevel2 {
  margin-left: 2em;
  font-size: 0.9em;
}
div.toclevel3 {
  margin-left: 4em;
  font-size: 0.9em;
}
div.toclevel4 {
  margin-left: 6em;
  font-size: 0.9em;
}

span.aqua { color: aqua; }
span.black { color: black; }
span.blue { color: blue; }
span.fuchsia { color: fuchsia; }
span.gray { color: gray; }
span.green { color: green; }
span.lime { color: lime; }
span.maroon { color: maroon; }
span.navy { color: navy; }
span.olive { color: olive; }
span.purple { color: purple; }
span.red { color: red; }
span.silver { color: silver; }
span.teal { color: teal; }
span.white { color: white; }
span.yellow { color: yellow; }

span.aqua-background { background: aqua; }
span.black-background { background: black; }
span.blue-background { background: blue; }
span.fuchsia-background { background: fuchsia; }
span.gray-background { background: gray; }
span.green-background { background: green; }
span.lime-background { background: lime; }
span.maroon-background { background: maroon; }
span.navy-background { background: navy; }
span.olive-background { background: olive; }
span.purple-background { background: purple; }
span.red-background { background: red; }
span.silver-background { background: silver; }
span.teal-background { background: teal; }
span.white-background { background: white; }
span.yellow-background { background: yellow; }

span.big { font-size: 2em; }
span.small { font-size: 0.6em; }

span.underline { text-decoration: underline; }
span.overline { text-decoration: overline; }
span.line-through { text-decoration: line-through; }

div.unbreakable { page-break-inside: avoid; }


/*
 * xhtml11 specific
 *
 * */

div.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.tableblock > table {
  border: 3px solid #527bbd;
}
thead, p.table.header {
  font-weight: bold;
  color: #527bbd;
}
p.table {
  margin-top: 0;
}
/* Because the table frame attribute is overriden by CSS in most browsers. */
div.tableblock > table[frame="void"] {
  border-style: none;
}
div.tableblock > table[frame="hsides"] {
  border-left-style: none;
  border-right-style: none;
}
div.tableblock > table[frame="vsides"] {
  border-top-style: none;
  border-bottom-style: none;
}


/*
 * html5 specific
 *
 * */

table.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
thead, p.tableblock.header {
  font-weight: bold;
  color: #527bbd;
}
p.tableblock {
  margin-top: 0;
}
table.tableblock {
  border-width: 3px;
  border-spacing: 0px;
  border-style: solid;
  border-color: #527bbd;
  border-collapse: collapse;
}
th.tableblock, td.tableblock {
  border-width: 1px;
  padding: 4px;
  border-style: solid;
  border-color: #527bbd;
}

table.tableblock.frame-topbot {
  border-left-style: hidden;
  border-right-style: hidden;
}
table.tableblock.frame-sides {
  border-top-style: hidden;
  border-bottom-style: hidden;
}
table.tableblock.frame-none {
  border-style: hidden;
}

th.tableblock.halign-left, td.tableblock.halign-left {
  text-align: left;
}
th.tableblock.halign-center, td.tableblock.halign-center {
  text-align: center;
}
th.tableblock.halign-right, td.tableblock.halign-right {
  text-align: right;
}

th.tableblock.valign-top, td.tableblock.valign-top {
  vertical-align: top;
}
th.tableblock.valign-middle, td.tableblock.valign-middle {
  vertical-align: middle;
}
th.tableblock.valign-bottom, td.tableblock.valign-bottom {
  vertical-align: bottom;
}


/*
 * manpage specific
 *
 * */

body.manpage h1 {
  padding-top: 0.5em;
  padding-bottom: 0.5em;
  border-top: 2px solid silver;
  border-bottom: 2px solid silver;
}
body.manpage h2 {
  border-style: none;
}
body.manpage div.sectionbody {
  margin-left: 3em;
}

@media print {
  body.manpage div#toc { display: none; }
}


</style>
<script type="text/javascript">
/*<![CDATA[*/
var asciidoc = {  // Namespace.

/////////////////////////////////////////////////////////////////////
// Table Of Contents generator
/////////////////////////////////////////////////////////////////////

/* Author: Mihai Bazon, September 2002
 * http://students.infoiasi.ro/~mishoo
 *
 * Table Of Content generator
 * Version: 0.4
 *
 * Feel free to use this script under the terms of the GNU General Public
 * License, as long as you do not remove or alter this notice.
 */

 /* modified by Troy D. Hanson, September 2006. License: GPL */
 /* modified by Stuart Rackham, 2006, 2009. License: GPL */

// toclevels = 1..4.
toc: function (toclevels) {

  function getText(el) {
    var text = "";
    for (var i = el.firstChild; i != null; i = i.nextSibling) {
      if (i.nodeType == 3 /* Node.TEXT_NODE */) // IE doesn't speak constants.
        text += i.data;
      else if (i.firstChild != null)
        text += getText(i);
    }
    return text;
  }

  function TocEntry(el, text, toclevel) {
    this.element = el;
    this.text = text;
    this.toclevel = toclevel;
  }

  function tocEntries(el, toclevels) {
    var result = new Array;
    var re = new RegExp('[hH]([1-'+(toclevels+1)+'])');
    // Function that scans the DOM tree for header elements (the DOM2
    // nodeIterator API would be a better technique but not supported by all
    // browsers).
    var iterate = function (el) {
      for (var i = el.firstChild; i != null; i = i.nextSibling) {
        if (i.nodeType == 1 /* Node.ELEMENT_NODE */) {
          var mo = re.exec(i.tagName);
          if (mo && (i.getAttribute("class") || i.getAttribute("className")) != "float") {
            result[result.length] = new TocEntry(i, getText(i), mo[1]-1);
          }
          iterate(i);
        }
      }
    }
    iterate(el);
    return result;
  }

  var toc = document.getElementById("toc");
  if (!toc) {
    return;
  }

  // Delete existing TOC entries in case we're reloading the TOC.
  var tocEntriesToRemove = [];
  var i;
  for (i = 0; i < toc.childNodes.length; i++) {
    var entry = toc.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div'
     && entry.getAttribute("class")
     && entry.getAttribute("class").match(/^toclevel/))
      tocEntriesToRemove.push(entry);
  }
  for (i = 0; i < tocEntriesToRemove.length; i++) {
    toc.removeChild(tocEntriesToRemove[i]);
  }

  // Rebuild TOC entries.
  var entries = tocEntries(document.getElementById("content"), toclevels);
  for (var i = 0; i < entries.length; ++i) {
    var entry = entries[i];
    if (entry.element.id == "")
      entry.element.id = "_toc_" + i;
    var a = document.createElement("a");
    a.href = "#" + entry.element.id;
    a.appendChild(document.createTextNode(entry.text));
    var div = document.createElement("div");
    div.appendChild(a);
    div.className = "toclevel" + entry.toclevel;
    toc.appendChild(div);
  }
  if (entries.length == 0)
    toc.parentNode.removeChild(toc);
},


/////////////////////////////////////////////////////////////////////
// Footnotes generator
/////////////////////////////////////////////////////////////////////

/* Based on footnote generation code from:
 * http://www.brandspankingnew.net/archive/2005/07/format_footnote.html
 */

footnotes: function () {
  // Delete existing footnote entries in case we're reloading the footnodes.
  var i;
  var noteholder = document.getElementById("footnotes");
  if (!noteholder) {
    return;
  }
  var entriesToRemove = [];
  for (i = 0; i < noteholder.childNodes.length; i++) {
    var entry = noteholder.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div' && entry.getAttribute("class") == "footnote")
      entriesToRemove.push(entry);
  }
  for (i = 0; i < entriesToRemove.length; i++) {
    noteholder.removeChild(entriesToRemove[i]);
  }

  // Rebuild footnote entries.
  var cont = document.getElementById("content");
  var spans = cont.getElementsByTagName("span");
  var refs = {};
  var n = 0;
  for (i=0; i<spans.length; i++) {
    if (spans[i].className == "footnote") {
      n++;
      var note = spans[i].getAttribute("data-note");
      if (!note) {
        // Use [\s\S] in place of . so multi-line matches work.
        // Because JavaScript has no s (dotall) regex flag.
        note = spans[i].innerHTML.match(/\s*\[([\s\S]*)]\s*/)[1];
        spans[i].innerHTML =
          "[<a id='_footnoteref_" + n + "' href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
        spans[i].setAttribute("data-note", note);
      }
      noteholder.innerHTML +=
        "<div class='footnote' id='_footnote_" + n + "'>" +
        "<a href='#_footnoteref_" + n + "' title='Return to text'>" +
        n + "</a>. " + note + "</div>";
      var id =spans[i].getAttribute("id");
      if (id != null) refs["#"+id] = n;
    }
  }
  if (n == 0)
    noteholder.parentNode.removeChild(noteholder);
  else {
    // Process footnoterefs.
    for (i=0; i<spans.length; i++) {
      if (spans[i].className == "footnoteref") {
        var href = spans[i].getElementsByTagName("a")[0].getAttribute("href");
        href = href.match(/#.*/)[0];  // Because IE return full URL.
        n = refs[href];
        spans[i].innerHTML =
          "[<a href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
      }
    }
  }
},

install: function(toclevels) {
  var timerId;

  function reinstall() {
    asciidoc.footnotes();
    if (toclevels) {
      asciidoc.toc(toclevels);
    }
  }

  function reinstallAndRemoveTimer() {
    clearInterval(timerId);
    reinstall();
  }

  timerId = setInterval(reinstall, 500);
  if (document.addEventListener)
    document.addEventListener("DOMContentLoaded", reinstallAndRemoveTimer, false);
  else
    window.onload = reinstallAndRemoveTimer;
}

}
asciidoc.install();
/*]]>*/
</script>
</head>
<body class="book">
<div id="header">
<h1>Automation for Everyone</h1>
</div>
<div id="content">
<div class="sect1">
<h2 id="_table_of_contents">Table of Contents</h2>
<div class="sectionbody">
<div class="ulist"><ul>
<li>
<p>
<a href="https://docs.ansibleworkshop.com/index.html">Agenda</a>
</p>
</li>
<li>
<p>
<a href="https://docs.ansibleworkshop.com/exercise1.html">Exercise 1 - Configuring Ansible Tower</a>
</p>
</li>
<li>
<p>
<a href="https://docs.ansibleworkshop.com/exercise2.html">Exercise 2 - Ad-hoc commands in Tower</a>
</p>
</li>
<li>
<p>
<a href="https://docs.ansibleworkshop.com/exercise3.html">Exercise 3 - Writing Your First playbook</a>
</p>
</li>
<li>
<p>
<a href="https://docs.ansibleworkshop.com/exercise4.html">Exercise 4 - Creating and Running a Job Template</a>
</p>
</li>
<li>
<p>
<a href="https://docs.ansibleworkshop.com/exercise5.html">Exercise 5 - Using Variables, Loops, and Handlers</a>
</p>
</li>
<li>
<p>
<a href="https://docs.ansibleworkshop.com/exercise6.html">Exercise 6 - Roles: Making your playbooks reusable</a>
</p>
</li>
<li>
<p>
<a href="https://docs.ansibleworkshop.com/exercise7.html">Exercise 7 - Using Ansible for Windows Patching</a>
</p>
</li>
<li>
<p>
<a href="https://docs.ansibleworkshop.com/wrapup.html">Wrap UP</a>
</p>
</li>
</ul></div>
</div>
</div>
<h1 id="_exercise_5_using_variables_loops_and_handlers">Exercise 5 - Using Variables, Loops, and Handlers</h1>
<div class="paragraph"><p>Previous exercises showed you the basics of Ansible playbooks.  In the next few exercises, we are going
to teach some more advanced ansible skills that will add flexibility and power to your playbooks.</p></div>
<div class="paragraph"><p>Ansible exists to make tasks simple and repeatable.  We also know that not all systems are exactly alike and often require
some slight change to the way an Ansible playbook is run.  Enter variables.</p></div>
<div class="paragraph"><p>Variables are how we deal with differences between your systems, allowing you to account for a change in port, IP address
or directory.</p></div>
<div class="paragraph"><p>Loops enable us to repeat the same task over and over again.  For example, lets say you want to start multiple services, install several features, or create multiple directories.
By using an ansible loop, you can do that in a single task.</p></div>
<div class="paragraph"><p>Handlers are the way in which we restart services.  Did you just deploy a new config file, install a new package?
If so, you may need to restart a service for those changes to take effect.  We do that with a handler.</p></div>
<div class="paragraph"><p>For a full understanding of variables, loops, and handlers; check out our Ansible documentation on these subjects.<br>
<a href="http://docs.ansible.com/ansible/latest/playbooks_variables.html">Ansible Variables</a><br>
<a href="http://docs.ansible.com/ansible/latest/playbooks_loops.html">Ansible Loops</a><br>
<a href="http://docs.ansible.com/ansible/latest/playbooks_intro.html#handlers-running-operations-on-change">Ansible Handlers</a></p></div>
<div class="sect1">
<h2 id="_section_1_creating_the_playbook">Section 1: Creating the Playbook</h2>
<div class="sectionbody">
<div class="paragraph"><p>To begin, we are going to create a new playbook, but it should look very familiar to the one you created in exercise 3</p></div>
<div class="sect2">
<h3 id="_step_1">Step 1:</h3>
<div class="paragraph"><p>Within Visual Studio Code, create a new directory in your git repo and create a site.yml file.</p></div>
<div class="paragraph"><p>In the Explorer accordion you should have a <em>student#</em> section where you previously made iis_basic.</p></div>
<div class="imageblock">
<div class="content">
<img src="./Automation for Everyone 5_files/5-vscode-existing-folders.png" alt="images/5-vscode-existing-folders.png" width="400">
</div>
<div class="title">Figure 1. Student Playbooks</div>
</div>
</div>
<div class="sect2">
<h3 id="_step_2_create_a_folder_called_strong_iis_advanced_strong_and_a_file_called_code_site_yml_code">Step 2: Create a folder called <strong>iis_advanced</strong> and a file called <code>site.yml</code></h3>
<div class="paragraph"><p>Hover over the <em>student#</em> section and click the <em>New Folder</em> button</p></div>
<div class="paragraph"><p>Type iis_advanced and hit enter.  Then click that folder so it is selected.</p></div>
<div class="paragraph"><p>Hover over the <em>student#</em> section again and click the <em>New File</em> button.</p></div>
<div class="paragraph"><p>Type site.yml and hit enter.</p></div>
<div class="paragraph"><p>You should now have an editor open in the right pane that can be used for creating your playbook.</p></div>
<div class="imageblock">
<div class="content">
<img src="./Automation for Everyone 5_files/5-vscode-create-folders.png" alt="images/5-vscode-create-folders.png" width="1000">
</div>
<div class="title">Figure 2. Empty site.yml</div>
</div>
</div>
<div class="sect2">
<h3 id="_step_3">Step 3:</h3>
<div class="paragraph"><p>Add a play definition and some variables to your playbook.  These include addtional packages your playbook will install on your web servers, plus some web server specific configurations.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>---
- hosts: Windows
  name: This is a play within a playbook
  vars:
    iis_sites:
      - name: 'Ansible Playbook Test'
        port: '8080'
        path: 'C:\sites\playbooktest'
      - name: 'Ansible Playbook Test 2'
        port: '8081'
        path: 'C:\sites\playbooktest2'
    iis_test_message: "Hello World!  My test IIS Server"</code></pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_step_4">Step 4:</h3>
<div class="paragraph"><p>Add a new task called <strong>install IIS</strong>.
After writing the playbook, click <code>File</code> &gt; <code>Save</code> to save your changes.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>  tasks:
    - name: Install IIS
      win_feature:
        name: Web-Server
        state: present

    - name: Create site directory structure
      win_file:
        path: "{{ item.path }}"
        state: directory
      with_items: "{{ iis_sites }}"

    - name: Create IIS site
      win_iis_website:
        name: "{{ item.name }}"
        state: started
        port: "{{ item.port }}"
        physical_path: "{{ item.path }}"
      with_items: "{{ iis_sites }}"
      notify: restart iis service</code></pre>
</div></div>
<div class="imageblock">
<div class="content">
<img src="./Automation for Everyone 5_files/5-vscode-iis-yaml.png" alt="images/5-vscode-iis-yaml.png" width="1000">
</div>
<div class="title">Figure 3. site.yml part 1</div>
</div>
<div class="admonitionblock">
<table><tbody><tr>
<td class="icon">
<img src="./Automation for Everyone 5_files/note.png" alt="Note">
</td>
<td class="content">
<div class="paragraph"><p><strong>What is happening here!?</strong><br></p></div>
<div class="ulist"><ul>
<li>
<p>
<code>vars:</code> You’ve told Ansible the next thing it sees will be a variable name<br>
</p>
</li>
<li>
<p>
<code>iis_sites</code> You are defining a list-type variable called iis_sites.  What follows
is a list of each site with it’s related variables<br>
</p>
</li>
<li>
<p>
<code>file:</code> This module is used to create, modify, delete files, directories, and symlinks.
</p>
</li>
<li>
<p>
<code>{{ item }}</code> You are telling Ansible that this will expand into a list item.  Each item has several variables like <code>name</code>, <code>port</code>, and <code>path</code>.<br>
</p>
</li>
<li>
<p>
<code>with_items: "{{ iis_sites }}</code> This is your loop which is instructing Ansible to perform this task on
every <code>item</code> in <code>iis_sites</code>
</p>
</li>
<li>
<p>
<code>notify: restart iis service</code> This statement is a <code>handler</code>, so we’ll come back to it in Section 3.
</p>
</li>
</ul></div>
</td>
</tr></tbody></table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_section_2_opening_firewall_and_deploying_files">Section 2: Opening Firewall and Deploying Files</h2>
<div class="sectionbody">
<div class="paragraph"><p></p></div>
<div class="paragraph"><p>After that, you will define a task to start the IIS service.</p></div>
<div class="sect2">
<h3 id="_step_1_2">Step 1:</h3>
<div class="paragraph"><p>Create a <code>templates</code> directory in your project directory and create a template as follows:</p></div>
<div class="paragraph"><p>Ensure your <strong>iis_advanced folder</strong> is highlighted and then hover over the <em>student#</em> section and click the <em>New Folder</em> button</p></div>
<div class="paragraph"><p>Type templates and hit enter.  Then click that folder so it is selected.</p></div>
<div class="paragraph"><p>Hover over the <em>templates</em> folder and click the <em>New File</em> button.</p></div>
<div class="paragraph"><p>Type index.html.j2 and hit enter.</p></div>
<div class="paragraph"><p>You should now have an editor open in the right pane that can be used for creating your template.  Enter the following details:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>&lt;html&gt;
&lt;body&gt;

  &lt;p align=center&gt;&lt;img src='http://docs.ansible.com/images/logo.png' align=center&gt;
  &lt;h1 align=center&gt;{{ ansible_hostname }} --- {{ iis_test_message }}

&lt;/body&gt;
&lt;/html&gt;</code></pre>
</div></div>
<div class="imageblock">
<div class="content">
<img src="./Automation for Everyone 5_files/5-vscode-template.png" alt="images/5-vscode-template.png" width="1000">
</div>
<div class="title">Figure 4. index.html template</div>
</div>
</div>
<div class="sect2">
<h3 id="_step_2">Step 2:</h3>
<div class="paragraph"><p>Edit back your playbook, <code>site.yml</code>, by opening your firewall ports and writing the template.  Use single quotes for <code>win_template</code> in order to not escape the forward slash.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>    - name: Open port for site on the firewall
      win_firewall_rule:
        name: "iisport{{ item.port }}"
        enable: yes
        state: present
        localport: "{{ item.port }}"
        action: Allow
        direction: In
        protocol: Tcp
      with_items: "{{ iis_sites }}"

    - name: Template simple web site to iis_site_path as index.html
      win_template:
        src: 'index.html.j2'
        dest: '{{ item.path }}\index.html'
      with_items: "{{ iis_sites }}"</code></pre>
</div></div>
<div class="admonitionblock">
<table><tbody><tr>
<td class="icon">
<img src="./Automation for Everyone 5_files/note.png" alt="Note">
</td>
<td class="content">
<div class="paragraph"><p><strong>So… what did I just write?</strong></p></div>
<div class="ulist"><ul>
<li>
<p>
<code>win_firewall_rule:</code> This module is used to create, modify, and update firewall rules.  Note in the case of AWS there are also security group rules which may impact communication.  We’ve opened these for the ports in this example.
</p>
</li>
<li>
<p>
<code>win_template:</code> This module specifies that a jinja2 template is being used and deployed.
</p>
</li>
<li>
<p>
used in Ansible to transform data inside a template expression, i.e. filters.
</p>
</li>
</ul></div>
</td>
</tr></tbody></table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_section_3_defining_and_using_handlers">Section 3: Defining and Using Handlers</h2>
<div class="sectionbody">
<div class="paragraph"><p>There are any number of reasons we often need to restart a service/process including the deployment of a configuration file, installing a new package, etc.  There are really two parts to this Section; adding a handler to the playbook and calling the handler after the a task.  We will start with the former.</p></div>
<div class="paragraph"><p>The <code>handlers</code> block should start after a one-level indentation, that is, two spaces.
It should align with the <code>tasks</code> block.</p></div>
<div class="sect2">
<h3 id="_step_1_3">Step 1:</h3>
<div class="paragraph"><p>Define a handler.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>  handlers:
    - name: restart iis service
      win_service:
        name: W3Svc
        state: restarted
        start_mode: auto</code></pre>
</div></div>
<div class="admonitionblock">
<table><tbody><tr>
<td class="icon">
<img src="./Automation for Everyone 5_files/note.png" alt="Note">
</td>
<td class="content">
<div class="paragraph"><p><strong>You can’t have a former if you don’t mention the latter</strong></p></div>
<div class="ulist"><ul>
<li>
<p>
<code>handler:</code> This is telling the <strong>play</strong> that the <code>tasks:</code> are over, and now we are defining <code>handlers:</code>.
  Everything below that looks the same as any other task, i.e. you give it a name, a module, and the options for that
  module.  This is the definition of a handler.
</p>
</li>
<li>
<p>
<code>notify: restart iis service</code> …and here is your latter. Finally!  The <code>notify</code> statement is the invocation of a handler by
name.  Quite the reveal, we know.   You already noticed that you’ve added a <code>notify</code> statement to the <code>win_iis_website</code>
task, now you know why.
</p>
</li>
</ul></div>
</td>
</tr></tbody></table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_section_4_commit_and_review">Section 4: Commit and Review</h2>
<div class="sectionbody">
<div class="paragraph"><p>Your new, improved playbook is done! But remember we still need to commit the changes to source code control.</p></div>
<div class="paragraph"><p>Click <code>File</code> → <code>Save All</code> to save the files you’ve written</p></div>
<div class="imageblock">
<div class="content">
<img src="./Automation for Everyone 5_files/5-vscode-iis-yaml-2.png" alt="images/5-vscode-iis-yaml-2.png">
</div>
<div class="title">Figure 5. site.yml part 2</div>
</div>
<div class="paragraph"><p>Click the Source Code icon (1), type in a commit message such as <em>Adding advanced playbook</em> (2), and click the check box above (3).</p></div>
<div class="imageblock">
<div class="content">
<img src="./Automation for Everyone 5_files/5-commit.png" alt="images/5-commit.png">
</div>
<div class="title">Figure 6. Commit site.yml</div>
</div>
<div class="paragraph"><p>Sync to gitlab by clicking the arrows on the lower left blue bar.  When prompted, click <code>OK</code> to push and pull commits.</p></div>
<div class="imageblock">
<div class="content">
<img src="./Automation for Everyone 5_files/5-push.png" alt="images/5-push.png">
</div>
<div class="title">Figure 7. Push to Gitlab.yml</div>
</div>
<div class="paragraph"><p>It should take 5-30 seconds to finish the commit.  The blue bar should stop rotating and indicate 0 problems…</p></div>
<div class="paragraph"><p>Now let’s take a second look to make sure everything looks the way you intended.  If not, now is the time for us to fix it up. The figure below shows line counts and spacing.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>---
- hosts: Windows
  name: This is a play within a playbook
  vars:
    iis_sites:
      - name: 'Ansible Playbook Test'
        port: '8080'
        path: 'C:\sites\playbooktest'
      - name: 'Ansible Playbook Test 2'
        port: '8081'
        path: 'C:\sites\playbooktest2'
    iis_test_message: "Hello World!  My test IIS Server"

  tasks:
    - name: Install IIS
      win_feature:
        name: Web-Server
        state: present

    - name: Create site directory structure
      win_file:
        path: "{{ item.path }}"
        state: directory
      with_items: "{{ iis_sites }}"

    - name: Create IIS site
      win_iis_website:
        name: "{{ item.name }}"
        state: started
        port: "{{ item.port }}"
        physical_path: "{{ item.path }}"
      with_items: "{{ iis_sites }}"
      notify: restart iis service

    - name: Open port for site on the firewall
      win_firewall_rule:
        name: "iisport{{ item.port }}"
        enable: yes
        state: present
        localport: "{{ item.port }}"
        action: Allow
        direction: In
        protocol: Tcp
      with_items: "{{ iis_sites }}"

    - name: Template simple web site to iis_site_path as index.html
      win_template:
        src: 'index.html.j2'
        dest: '{{ item.path }}\index.html'
      with_items: "{{ iis_sites }}"

  handlers:
    - name: restart iis service
      win_service:
        name: W3Svc
        state: restarted
        start_mode: auto</code></pre>
</div></div>
</div>
</div>
<div class="sect1">
<h2 id="_section_5_create_your_job_template">Section 5: Create your Job Template</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_step_1_4">Step 1:</h3>
<div class="paragraph"><p>Before we can create our Job Template, you must first go resync your Project again.  So do that now.</p></div>
<div class="admonitionblock">
<table><tbody><tr>
<td class="icon">
<img src="./Automation for Everyone 5_files/note.png" alt="Note">
</td>
<td class="content">You must do this anytime you create a new <em>base</em> playbook file that you will be selecting via a Job Template.  The new file must be synced to Tower before it will become available in the Job Template playbook dropdown.</td>
</tr></tbody></table>
</div>
</div>
<div class="sect2">
<h3 id="_step_2_2">Step 2:</h3>
<div class="paragraph"><p>To test this playbook, we need to create a new Job Template to run this playbook.  So go to <em>Template</em> and click <em>Add</em> and select <code>Job Template</code> to create a second job template.</p></div>
<div class="paragraph"><p>Complete the form using the following values</p></div>
<div class="tableblock">
<table rules="all" width="100%" frame="border" cellspacing="0" cellpadding="4">
<colgroup><col width="50%">
<col width="50%">
</colgroup><tbody>
<tr>
<td align="left" valign="top"><p class="table">NAME</p></td>
<td align="left" valign="top"><p class="table">IIS Advanced</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">DESCRIPTION</p></td>
<td align="left" valign="top"><p class="table">Template for iis_advanced</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">JOB TYPE</p></td>
<td align="left" valign="top"><p class="table">Run</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">INVENTORY</p></td>
<td align="left" valign="top"><p class="table">Ansible Workshop Inventory</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">PROJECT</p></td>
<td align="left" valign="top"><p class="table">Ansible Workshop Project</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">PLAYBOOK</p></td>
<td align="left" valign="top"><p class="table">iis_advanced/site.yml</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">MACHINE CREDENTIAL</p></td>
<td align="left" valign="top"><p class="table">Student Account</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">LIMIT</p></td>
<td align="left" valign="top"><p class="table">Windows</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">OPTIONS</p></td>
<td align="left" valign="top"><div><div class="ulist"><ul>
<li>
<p>
[*] USE FACT CACHE
</p>
</li>
</ul></div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="imageblock">
<div class="content">
<img src="./Automation for Everyone 5_files/5-create-template.png" alt="images/5-create-template.png" width="1000">
</div>
<div class="title">Figure 8. Create Job Template</div>
</div>
</div>
<div class="sect2">
<h3 id="_step_3_2">Step 3:</h3>
<div class="paragraph"><p>Click SAVE <span class="image">
<img src="./Automation for Everyone 5_files/at_save.png" alt="Save">
</span> and then select ADD SURVEY <span class="image">
<img src="./Automation for Everyone 5_files/at_add_survey.png" alt="Add">
</span></p></div>
</div>
<div class="sect2">
<h3 id="_step_4_2">Step 4:</h3>
<div class="paragraph"><p>Complete the survey form with following values</p></div>
<div class="tableblock">
<table rules="all" width="100%" frame="border" cellspacing="0" cellpadding="4">
<colgroup><col width="50%">
<col width="50%">
</colgroup><tbody>
<tr>
<td align="left" valign="top"><p class="table">PROMPT</p></td>
<td align="left" valign="top"><p class="table">Please enter a test message for your new website</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">DESCRIPTION</p></td>
<td align="left" valign="top"><p class="table">Website test message prompt</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">ANSWER VARIABLE NAME</p></td>
<td align="left" valign="top"><p class="table">iis_test_message</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">ANSWER TYPE</p></td>
<td align="left" valign="top"><p class="table">Text</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">MINIMUM/MAXIMUM LENGTH</p></td>
<td align="left" valign="top"><p class="table">Use the defaults</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">DEFAULT ANSWER</p></td>
<td align="left" valign="top"><p class="table"><em>Be creative, keep it clean, we’re all professionals here</em></p></td>
</tr>
</tbody>
</table>
</div>
<div class="imageblock">
<div class="content">
<img src="./Automation for Everyone 5_files/5-survey.png" alt="images/5-survey.png" width="500">
</div>
<div class="title">Figure 9. Survey Form</div>
</div>
</div>
<div class="sect2">
<h3 id="_step_5">Step 5:</h3>
<div class="paragraph"><p>Select ADD <span class="image">
<img src="./Automation for Everyone 5_files/at_add.png" alt="Add">
</span></p></div>
</div>
<div class="sect2">
<h3 id="_step_6">Step 6:</h3>
<div class="paragraph"><p>Select SAVE <span class="image">
<img src="./Automation for Everyone 5_files/at_save.png" alt="Add">
</span></p></div>
</div>
<div class="sect2">
<h3 id="_step_7">Step 7:</h3>
<div class="paragraph"><p>Back on the main Job Template page, select SAVE <span class="image">
<img src="./Automation for Everyone 5_files/at_save.png" alt="Add">
</span> again.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_section_6_running_your_new_playbook">Section 6: Running your new playbook</h2>
<div class="sectionbody">
<div class="paragraph"><p>Now let’s run it and see how it works.</p></div>
<div class="sect2">
<h3 id="_step_1_5">Step 1:</h3>
<div class="paragraph"><p>Select TEMPLATES</p></div>
<div class="admonitionblock">
<table><tbody><tr>
<td class="icon">
<img src="./Automation for Everyone 5_files/note.png" alt="Note">
</td>
<td class="content">Alternatively, if you haven’t navigated away from the job templates creation page, you can scroll down to see all existing job templates</td>
</tr></tbody></table>
</div>
</div>
<div class="sect2">
<h3 id="_step_2_3">Step 2:</h3>
<div class="paragraph"><p>Click the rocketship icon <span class="image">
<img src="./Automation for Everyone 5_files/at_launch_icon.png" alt="Add">
</span> for the <strong>IIS Advanced</strong> Job Template.</p></div>
</div>
<div class="sect2">
<h3 id="_step_3_3">Step 3:</h3>
<div class="paragraph"><p>When prompted, enter your desired test message</p></div>
<div class="paragraph"><p>After it launches, you should be redirected and can watch the output of the job in real time.</p></div>
<div class="paragraph"><p>Once your job is successful, navigate to your new websites (replace # with your student number)</p></div>
<div class="listingblock">
<div class="content">
<pre><code>http://s#-win1.ansibleworkshop.com:8080</code></pre>
</div></div>
<div class="paragraph"><p>and</p></div>
<div class="listingblock">
<div class="content">
<pre><code>http://s#-win1.ansibleworkshop.com:8081</code></pre>
</div></div>
</div>
</div>
</div>
</div>

<div id="footer">
<div id="footer-text">
Last updated 2019-09-25 03:40:27 UTC
</div>
<div id="footer-badges">
<a href="http://validator.w3.org/check?uri=referer">
  <img style="border:0;width:88px;height:31px" src="./Automation for Everyone 5_files/valid-xhtml11-blue" alt="Valid XHTML 1.1" height="31" width="88">
</a>
<a href="http://jigsaw.w3.org/css-validator/">
  <img style="border:0;width:88px;height:31px" src="./Automation for Everyone 5_files/vcss-blue" alt="Valid CSS!">
</a>
</div>
</div>


</body></html>